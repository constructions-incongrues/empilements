#!/usr/bin/env php
<?php
$directoryRoot = $_SERVER['argv'][1];
$tracks = glob($directoryRoot.'/tracks/*.mp3');
$manifest = parse_ini_file($directoryRoot.'/manifest.ini');
$url = 'http://empilements.incongru.org/';
$compilationTitle = utf8_decode($manifest['title']);
foreach ($tracks as $track) {
	$matches = array();
	preg_match('/^(\d+) - (.*) - (.*).mp3$/', basename($track), $matches);
	$matches = array_map('utf8_decode', $matches);
	
	// Remove all tags
	system(sprintf("/usr/bin/id3v2 --delete-all \"%s\"", addcslashes($track, '"')));	

	// Create tags from track filename
	$cmd = sprintf("/usr/bin/id3v2 --artist \"%s\" --album \"%s\" --song \"%s\" --comment \"%s\" --track '%d/%d' \"%s\"", addcslashes($matches[2], '"'), $compilationTitle, addcslashes($matches[3], '"'), $url, addcslashes($matches[1], '"'), count($tracks), addcslashes($track, '"'));
	system($cmd);
}
