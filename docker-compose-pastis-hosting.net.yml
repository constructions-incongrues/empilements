version: '2'

networks:
  default:
    external:
      name: traefikpastishostingnet_default

services:
  api:
    image: directus/api:2.0.18
    environment:
      DATABASE_HOST: 172.17.0.1
      DATABASE_NAME: "empilements"
      DATABASE_USERNAME: "empilements"
      DATABASE_PASSWORD: "s3%2a7zP"
    labels:
      traefik.frontend.rule: "Host:empilements.incongru.org; PathPrefixStrip:/api"
      traefik.port: "80"
    volumes:
      - ./etc/api.php.ini:/etc/php7/conf.d/99_empilements.ini
      - ./src/public/var:/var/www/html/public/uploads/_/originals/var
      - ./etc/Thumbnailer.php:/var/www/html/src/core/Directus/Filesystem/Thumbnailer.php

  php:
    build: .
    command: ["/bin/sh", "-c", "make configure && php -S 0.0.0.0:8000 -t public"]
    image: constructionsincongrues/empilements
    labels:
      traefik.frontend.rule: "Host:empilements.incongru.org"
      traefik.port: "8000"
    volumes:
      - ./src:/usr/local/src
